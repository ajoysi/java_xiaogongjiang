var _current_div='';var _current_type='';var _current_mode='article';var _current_relation_id='';var _current_callback='';var _session_id;var _timestamp='';var _token='';var _is_auto=false;//是否单文件上传var _fileSizeLimit='10000KB';var _fileTypeExts='*';var _fileTypeDesc='(*.*)';var file_path = '';// 上传之后的文件路径function file_upload(up_div,type,url){		if(up_div==undefined || up_div==''  || type==undefined)return false;		var html='<div id="fileManager"><div class="fileManager_content"><br><div id="m_fileupload"><input type="file" name="uploadify" id="uploadify"/><input type="button" value="开始上传" style="display:none" class="btn btn-info btn-mini start_btn" onclick="$(\'#uploadify\').uploadify(\'upload\',\'*\');"></div><div id="m_right"></div></div></div>';		$.webox({			height:_is_auto?150:330,			width:500,			bgvisibel:true,			title:'文件上传',			html:html		});		_current_div=up_div;		_current_type=type;		update_flie();	};function update_flie (){	var is_success=true;	if(_current_type!=undefined && _current_type!=''){	if(_token=='' || _timestamp==''){alert("密钥丢失无法上传!");return;}	//文件上传		$(function() {  			$("#uploadify").uploadify({				'formData' : {					'timestamp' : _timestamp,					'token'     : _token,					'type'		: _current_type,					'session_id'	: _session_id,					'mode'	: _current_mode,                    'up_div'	: _current_div			   },			   'auto' : _is_auto,			   'method' : "post",   			   'swf' : '/hxqcad/js/uploadify/images/uploadify.swf',			   'uploader' : '/Aopt/Upload/upload/file/uploadify',			   'fileTypeDesc' : _fileTypeDesc,			//描述  			   'fileTypeExts' : _fileTypeExts,          //文件类型  			   'fileSizeLimit' : _fileSizeLimit,          //文件大小  			   'buttonText' : '选择文件',				//按钮名称  			   'fileObjName'    :'uploadify',			   'checkExisting' : false,			   'successTimeout' : '3',			   'requeueErrors' : false,			   'debug':false,			   'removeTimeout' : '1',  			   'removeCompleted' : true,			   'height' : '17',			   'width' : '65',			   'onUploadSuccess': function(file, data, response){						if(response==true){							var dataObj=eval("("+data+")");//转换为json对象								if(!dataObj.status){//成功上传									is_success=false;									alert('上传失败！ 原因:'+dataObj.data);									return;								}								 file_path = dataObj.data.file_path + dataObj.data.file_name;								 								 // 填充最新图片								 var full_image = file_path;								 var append_html = '<ul><li><img src="'+full_image+'"></li></ul>' ;							     $('#fileList').html(append_html);								callback(dataObj.data);						}else{							alert('服务器无法连接');						}			    },			   'onSelect' : function(file){					if(!_is_auto){						$('input.start_btn').show();					}				},			   'onQueueComplete' : function(queueData){					if(!is_success)return;					//	if(!confirm("还需要上传文件吗?")){						if(_current_callback==''){							get_file_list(_current_div,_current_type);						}						$('.webox').fadeOut(300);						$('.background').css({display:'none'});					//}			   } 			});		});	}else{		alert("请选择上传文件夹!");	}}function callback(obj){		try 		{  			if(typeof(eval(_current_callback))=="function"){				eval(_current_callback+'(obj)');//callback			}		}		catch(e)		{		}}//---------------------------------------------------------HTML-------------------------------------------------------------------------------//********************************************************************************************************************************************//---------------------------------------------------------CODE-------------------------------------------------------------------------------function get_file_list(div,type){	return; 	if(type==undefined || div==undefined || _current_mode==undefined){		alert('参数加载失败!');		return;	}	_current_type=type;	_current_div=div;	console.log(_current_relation_id);	$.ajax({			 type:"POST",			 url:'/Aopt/Upload/ajax_get_files_list',			 data:'relation_id='+_current_relation_id+'&type='+type+'&mode='+_current_mode,			 dataType:'json',			 success:function(data){			 if(data=='' || data==undefined){			 	var str='<p>没有文件显示, 请上传</p>';			 }else{				var str='<ul>';				$(data).each(function(k,v){					var _class=(type!=1)?'hide':'';					if(v.id==0){					str+='<li><a class="del" fid='+v.id+' sn='+v.sn+'><i class="icon-remove"></i></a><a class="las" title="未保存状态"><font><img src="'+v.path+'"></font><span>未保存状态</span></a></li>';					}else{					str+='<li><input type="button" value="查看" onclick="view_info('+v.id+',\''+div+'\','+type+')" class="view btn btn-mini"/><div class="icon '+_class+'"><i class="'+(v.focus==1?'icon-bookmark':'icon-bookmark-empty')+'"></i><i class="'+(v.is_display==1?'icon-check':'icon-check-empty')+'"></i></div><a class="del" fid='+v.id+'><i class="icon-remove"></i></a><a class="la"><font><img src="'+v.path+'"></font><span title="'+v.title+'">'+(v.title?v.j_title:'文件名称')+'</span></a></li>';					}				});				str+='</ul>';				}				$('#'+div+' div.list').html(str);			 },			timeout:5000,			error:function(){				alert('请求超时，请重试！');			}	 });}function view_info(id,div,type){	if(id==undefined || id=='')return false;	$.ajax({				 type:"POST",				 url:'/Aopt/Upload/ajax_get_files_info',				 data:'id='+id+'&mode='+_current_mode,				 dataType:'json',				 success:function(data){					if(data.id>0){					var _class=(type!=1)?'class="hide"':'';					var html='<table width="480" height="250" border="0" cellpadding="2" cellspacing="2" id="info_tab" style="margin-top:5px;" tardiv="'+div+'" tartype="'+type+'" fid="'+data.id+'"><tr '+_class+'><td width="49">显示:</td><td width="60"><input type="checkbox" name="is_display" '+(data.is_display==1?'checked':'')+' value="1" />';						html+='</td><td width="217">&nbsp;焦点:&nbsp;<input type="checkbox" name="focus" '+(data.focus==1?'checked':'')+' value="1" /></td></tr><tr><td height="23">标题:&nbsp;</td><td colspan="2"><input name="title" type="text" style="width:380px;" value="'+data.title+'"/></td></tr><tr>  <td align="left">描述:</td>';						html+='<td colspan="2" align="left"><textarea name="describe"  style="width:420px;height:120px;">'+data.describe+'</textarea></td></tr><tr><td colspan="3" align="right" style=" padding-right:12px;"><input type="button" name="tosave" value="确定" class="btn btn-danger"/></td></tr></table>';					$.webox({						height:300,						width:500,						bgvisibel:true,						title:'图片信息',						html:html					});					$('#info_tab input[name=focus]').uniform();					$('#info_tab input[name=is_display]').uniform();					}else{						alert('数据错误！');					}				 },				timeout:5000,				error:function(){					alert('请求超时，请重试！');				}		 });}$('#info_tab input[name=tosave]').live("click",function(){			var _id=$('#info_tab').attr('fid');			var _title=$('#info_tab input[name=title]').val();			var _describe=$('#info_tab textarea[name=describe]').val();			var _focus=$('#info_tab input[name=focus]:checked').val();			var _is_display=$('#info_tab input[name=is_display]:checked').val();			var _div=$('#info_tab').attr('tardiv');			var _type=$('#info_tab').attr('tartype');			if(_focus==undefined)_focus=0;			if(_is_display==undefined)_is_display=0;			$.ajax({				 type:"POST",				 url:'/Aopt/Upload/ajax_save_files_info',				 data:'id='+_id+'&title='+_title+'&describe='+_describe+'&focus='+_focus+'&is_display='+_is_display+'&relation_id='+_current_relation_id+'&type='+_current_type+'&mode='+_current_mode,				 dataType:'json',				 success:function(data){					$('.webox').fadeOut(300);					$('.background').css({display:'none'});					get_file_list(_div,_type);				 },				timeout:5000,				error:function(){					alert('请求超时，请重试！');				}		 });});$('#file_content .list ul li .del').live("click",function(){	if(!confirm("确定删除吗?"))return false;	var _this=$(this);	var fid=_this.attr('fid');	var sn=_this.attr('sn');		if(fid==undefined || fid==''){			alert('操作失败!');			return;		}		 $.ajax({				 type:"POST",				 url:'/Aopt/Upload/ajax_del_file',				 data:'fid='+fid+'&mode='+_current_mode+'&sn='+sn,				 dataType:'json',				 success:function(data){					if(data=='0'){						alert('删除失败！');						return;					}					get_file_list(_current_div,_current_type);				 },				timeout:5000,				error:function(){					alert('请求超时，请重试！');				}		 });});$('#file_content .list ul li').live("mouseenter",function(){	$(this).children(".view").show();	$(this).children(".del").show();});$('#file_content .list ul li').live("mouseleave",function(){	$(this).children(".view").hide();	$(this).children(".del").hide();});$('input[name=del_btn]').live("click",function(){		var _id=$(this).parents().children(".b_img").attr('iid');		var _sn=$(this).parents().children(".b_img").attr('sn');        var _target=$(this).attr('_target');		$.ajax({				 type:"POST",				 url:'/Aopt/Upload/ajax_del_single_file',				 data:'iid='+_id+'&mode='+_current_mode+'&sn='+_sn,				 dataType:'json',				 success:function(data){					if(data=='0'){						alert('图片删除失败！');						return;					}					//-------------					try 					{  						if(typeof(eval('del_success'))=="function"){							eval('del_success(_target)');//callback						}					}					catch(e)					{					}					//-------------				 },				timeout:5000,				error:function(){					alert('请求超时，请重试！');				}		 });});